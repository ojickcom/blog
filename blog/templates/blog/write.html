{% extends 'base.html' %}

{% block title %}블로그 작성{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>✏️ 블로그 작성</h1>
</div>

<form method="post">
    {% csrf_token %}

    {# 클라이언트 선택 드롭다운 #}
    <div class="mb-3">
        <label for="{{ form.client.id_for_label }}" class="form-label">{{ form.client.label }}</label>
        {{ form.client }}
        {% if form.client.errors %}
            <div class="text-danger small mt-1">
                {% for error in form.client.errors %}{{ error }}{% endfor %}
            </div>
        {% endif %}
    </div>

    {# 동적으로 업데이트될 제목 구성 요소 표시 영역 #}
    <div class="mb-3 p-3 border rounded bg-light">
        <p class="mb-1 text-muted">아래 조합으로 블로그 포스팅 글을 작성해 보세요.</p>
        <p class="mb-1">
            <strong>글 주제: </strong> <span id="display-subhead" class="text-primary fw-bold">{{ generated_subhead }}</span>
        </p>
        <p class="mb-1">
            <strong>글자수: </strong> <span id="display-character" class="text-primary fw-bold">{{ generated_character }}</span>
        </p>
        <p class="mb-1">
            <strong>글어투: </strong> <span id="display-talkstyle" class="text-primary fw-bold">{{ generated_talkstyle }}</span>
        </p>
        <p class="mb-0">
            <strong>글의 대상: </strong> <span id="display-aspect" class="text-primary fw-bold">{{ generated_aspect }}</span>
        </p>
        <small class="text-muted mt-2 d-block">클라이언트 선택 시마다 내용이 랜덤으로 변경됩니다.</small>
    </div>

    <div class="mb-3">
        <label for="{{ form.content.id_for_label }}" class="form-label">{{ form.content.label }}</label>
        {{ form.content }}
        {% if form.content.errors %}
            <div class="text-danger small mt-1">
                {% for error in form.content.errors %}{{ error }}{% endfor %}
            </div>
        {% endif %}
    </div>

    <button type="submit" class="btn btn-success mt-3">저장하기</button>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const clientSelect = document.getElementById('{{ form.client.id_for_label }}');
    const displaySubhead = document.getElementById('display-subhead');
    const displayCharacter = document.getElementById('display-character');
    const displayTalkstyle = document.getElementById('display-talkstyle');
    const displayAspect = document.getElementById('display-aspect');

    // 랜덤 구성 요소를 가져와 업데이트하는 함수
    function updateRandomComponents() {
        const clientId = clientSelect.value;
        const url = `{% url 'get_random_title_components' %}?client_id=${clientId}`;

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                displaySubhead.textContent = data.generated_subhead || '';
                displayCharacter.textContent = data.generated_character || '';
                displayTalkstyle.textContent = data.generated_talkstyle || '';
                displayAspect.textContent = data.generated_aspect || '';
            })
            .catch(error => {
                console.error('Error fetching random title components:', error);
                // 오류 발생 시 사용자에게 알리거나 기본값 설정
                displaySubhead.textContent = '불러오기 오류';
                displayCharacter.textContent = '불러오기 오류';
                displayTalkstyle.textContent = '불러오기 오류';
                displayAspect.textContent = '불러오기 오류';
            });
    }

    // 클라이언트 선택 드롭다운 변경 시 이벤트 리스너
    clientSelect.addEventListener('change', updateRandomComponents);

    // 페이지 로드 시에도 초기 랜덤 구성 요소 표시
    // Django 뷰에서 이미 전달했으므로, JS는 초기 로드 시에는 필요 없고,
    // 클라이언트 선택이 변경될 때만 실행되도록 해도 됩니다.
    // 하지만 Admin에서 값을 비워두었을 경우를 대비하여 JS를 통해 한번 더 로드할 수 있습니다.
    // 현재는 Django 뷰에서 initial 값을 제공하고 있으므로, 클라이언트 선택이 변경될 때만 호출하면 됩니다.
    // 만약 페이지 로드 시에도 강제로 새로고침하고 싶다면 아래 주석을 해제하세요.
    // updateRandomComponents();
});
</script>
{% endblock %}
