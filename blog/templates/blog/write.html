{% extends 'base.html' %}

{% block title %}ë¸”ë¡œê·¸ ì‘ì„±{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>âœï¸ ë¸”ë¡œê·¸ ì‘ì„±</h1>
</div>

<form method="post">
    {% csrf_token %}

    {# í´ë¼ì´ì–¸íŠ¸ ì„ íƒ ë“œë¡­ë‹¤ìš´ #}
    <div class="mb-3">
        <label for="{{ form.client.id_for_label }}" class="form-label">{{ form.client.label }}</label>
        {{ form.client }}
        {% if form.client.errors %}
            <div class="text-danger small mt-1">
                {% for error in form.client.errors %}{{ error }}{% endfor %}
            </div>
        {% endif %}
    </div>

    {# b_title ì…ë ¥ í•„ë“œ ì¶”ê°€ #}
    <div class="mb-3">
        <label for="{{ form.b_title.id_for_label }}" class="form-label">{{ form.b_title.label }}</label>
        {{ form.b_title }}
        {% if form.b_title.errors %}
            <div class="text-danger small mt-1">
                {% for error in form.b_title.errors %}{{ error }}{% endfor %}
            </div>
        {% endif %}
    </div>

    {# ë™ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë  ì œëª© êµ¬ì„± ìš”ì†Œ í‘œì‹œ ì˜ì—­ #}
    <div class="mb-3 p-3 border rounded bg-light" id="title-components-display">
        <p class="mb-1">
            <strong>ê¸€ ì£¼ì œ: </strong> <span id="display-subhead" class="text-primary fw-bold">{{ generated_subhead }}</span>
        </p>
        <p class="mb-1">
            <strong>ê¸€ììˆ˜: </strong> <span id="display-character" class="text-primary fw-bold">{{ generated_character }}</span>
        </p>
        <p class="mb-1">
            <strong>ê¸€ì–´íˆ¬: </strong> <span id="display-talkstyle" class="text-primary fw-bold">{{ generated_talkstyle }}</span>
        </p>
        <p class="mb-0">
            <strong>ê¸€ì˜ ëŒ€ìƒ: </strong> <span id="display-aspect" class="text-primary fw-bold">{{ generated_aspect }}</span>
        </p>
        <small class="text-muted mt-2 d-block">í´ë¼ì´ì–¸íŠ¸ ì„ íƒ ì‹œë§ˆë‹¤ ë‚´ìš©ì´ ëœë¤ìœ¼ë¡œ ë³€ê²½ë©ë‹ˆë‹¤.</small>

        {# ë³µì‚¬ ë²„íŠ¼ ì¶”ê°€ #}
        <button type="button" id="copy-title-button" class="btn btn-sm btn-info mt-3">
            ğŸ“‹ ì œëª© ì¡°í•© ë³µì‚¬í•˜ê¸° <span id="copy-feedback" class="ms-2" style="display: none;">(ë³µì‚¬ë¨!)</span>
        </button>
            <button type="submit" class="btn btn-success mt-3">ì €ì¥í•˜ê¸°</button>
    </div>
    <div class="mb-3">
        <label for="{{ form.content.id_for_label }}" class="form-label">{{ form.content.label }}</label>
        {{ form.content }}
        {% if form.content.errors %}
            <div class="text-danger small mt-1">
                {% for error in form.content.errors %}{{ error }}{% endfor %}
            </div>
        {% endif %}
    </div>


</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const clientSelect = document.getElementById('{{ form.client.id_for_label }}');
    const displaySubhead = document.getElementById('display-subhead');
    const displayCharacter = document.getElementById('display-character');
    const displayTalkstyle = document.getElementById('display-talkstyle');
    const displayAspect = document.getElementById('display-aspect');
    const copyButton = document.getElementById('copy-title-button');
    const copyFeedback = document.getElementById('copy-feedback');

    // ëœë¤ êµ¬ì„± ìš”ì†Œë¥¼ ê°€ì ¸ì™€ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
    function updateRandomComponents() {
        const clientId = clientSelect.value;
        const url = `{% url 'get_random_title_components' %}?client_id=${clientId}`;

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                displaySubhead.textContent = data.generated_subhead || '';
                displayCharacter.textContent = data.generated_character || '';
                displayTalkstyle.textContent = data.generated_talkstyle || '';
                displayAspect.textContent = data.generated_aspect || '';
            })
            .catch(error => {
                console.error('Error fetching random title components:', error);
                displaySubhead.textContent = 'ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜';
                displayCharacter.textContent = 'ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜';
                displayTalkstyle.textContent = 'ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜';
                displayAspect.textContent = 'ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜';
            });
    }

    // ë³µì‚¬ ê¸°ëŠ¥ì„ ìˆ˜í–‰í•˜ëŠ” í•¨ìˆ˜
    function copyTitleComponents() {
        const subhead = displaySubhead.textContent;
        const character = displayCharacter.textContent;
        const talkstyle = displayTalkstyle.textContent;
        const client = clientSelect.options[clientSelect.selectedIndex].text; 

        const textToCopy = `ê¸€ ì£¼ì œ: ${subhead}\nê¸€ììˆ˜: ${character}\nê¸€ì–´íˆ¬: ${talkstyle}\n ê¸€ë‚´ìš©: ${client}ì„ ê¸€ ë‚´ìš©ì— í•œ ë²ˆ ì–¸ê¸‰í•˜ê³ , ì œëª©ê³¼ ë‚´ìš©ì— íŠ¹ìˆ˜ë¬¸ì, *,#ë¥¼ ë„£ì§€ ë§ê³ , ë‚´ìš©ì˜ ì œì¼ ì²«ì¤„ì€ ì œëª©ìœ¼ë¡œ 10ë‹¨ì–´ ë‚´ì™¸ë¡œ, ê·¸ë¦¬ê³  ê¸€ ì£¼ì œì—ì„œì— ëŒ€í•´ì„œ ìƒì—…ì  ë‚´ìš©ì´ ì•„ë‹Œ ì •ë³´ì„± ë¸”ë¡œê·¸ í¬ìŠ¤íŒ…ìš©ë„ë¡œ ê²€ìƒ‰ìì˜ ì˜ë„ë¥¼ íŒŒì•…í•´ì„œ ì ì–´ì¤˜. `;

        const tempTextArea = document.createElement('textarea');
        tempTextArea.value = textToCopy;
        document.body.appendChild(tempTextArea);
        tempTextArea.select();
        
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                copyFeedback.style.display = 'inline';
                setTimeout(() => {
                    copyFeedback.style.display = 'none';
                }, 2000);
            } else {
                console.warn('Fallback: Copying text command was unsuccessful.');
                // alert('í…ìŠ¤íŠ¸ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”: \n' + textToCopy); // Canvas í™˜ê²½ì—ì„œ alert ì‚¬ìš© ê¸ˆì§€
            }
        } catch (err) {
            console.error('Fallback: Oops, unable to copy', err);
            // alert('í…ìŠ¤íŠ¸ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”: \n' + textToCopy); // Canvas í™˜ê²½ì—ì„œ alert ì‚¬ìš© ê¸ˆì§€
        } finally {
            document.body.removeChild(tempTextArea);
        }
    }


    clientSelect.addEventListener('change', updateRandomComponents);
    copyButton.addEventListener('click', copyTitleComponents);

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ëœë¤ êµ¬ì„± ìš”ì†Œ í‘œì‹œ (ì´ë¯¸ ë·°ì—ì„œ ì „ë‹¬ë˜ì§€ë§Œ, í˜¹ì‹œ ëª¨ë¥¼ ê²½ìš°ë¥¼ ëŒ€ë¹„)
    if (clientSelect.value) { 
        // updateRandomComponents(); // í˜ì´ì§€ ë¡œë“œ ì‹œ Ajax í˜¸ì¶œ ë°©ì§€
    }
});
</script>
{% endblock %}
